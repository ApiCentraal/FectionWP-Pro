name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  checks:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php-version: [ '8.1', '8.2' ]
    steps:
      - uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: mbstring, intl, xml

      - name: PHP version
        run: php -v

      - name: Cache Composer vendor
        uses: actions/cache@v4
        with:
          path: vendor
          key: composer-${{ hashFiles('**/composer.lock') }}-php-${{ matrix.php-version }}
          restore-keys: composer-

      - name: Install Composer deps
        run: |
          composer install --no-interaction --no-progress --prefer-dist

      - name: PHP lint
        run: |
          set -e
          files=$(git ls-files '*.php' || true)
          if [ -z "${files}" ]; then
            echo "No PHP files to lint"
            exit 0
          fi
          echo "Running php -l on PHP files..."
          echo "${files}" | xargs -n1 -I{} php -l {}

      - name: Run PHPCS (WordPress standard)
        run: |
          if [ -f vendor/bin/phpcs ]; then
            echo "Running phpcs (WordPress) checks..."
            vendor/bin/phpcs --standard=WordPress --extensions=php -n .
          else
            echo "phpcs not available, skipping"
          fi

      - name: Run Theme Check (required)
        run: |
          if [ -f vendor/bin/theme-check ]; then
            echo "Running Theme Check..."
            vendor/bin/theme-check --severity=warning .
          else
            echo "theme-check not installed. Add 'wp-theme-check/wp-theme-check' to require-dev in composer.json to enable strict theme checks."
            exit 1
          fi

      - name: Setup Node (optional)
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Cache NPM
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: npm-

      - name: Install JS deps & build (if present)
        run: |
          if [ -f package.json ]; then
            npm ci
            if npm run | sed -n '2,200p' | grep -q "build"; then
              npm run build
            else
              echo "No build script defined, skipping build"
            fi
          else
            echo "No package.json, skipping JS steps"
          fi
